<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Cotizador Gauss Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root { --brand-orange:#ea8c2a; }

    body{
      margin:0;
      font-family: Verdana, Geneva, Tahoma, sans-serif;
      background:#f4f7ff;
      color:#1f2937;
    }

    .container{ max-width:1100px; margin:auto; padding:24px; }

    .header{ display:flex; align-items:center; gap:18px; margin-bottom:24px; }
    .header img{ height:120px; }
    .header h1{ margin:0; color:var(--brand-orange); font-size:28px; }

    .grid{ display:grid; grid-template-columns:1fr 2fr; gap:16px; }

    .card{
      background:white;
      border-radius:14px;
      padding:16px;
      box-shadow:0 10px 25px rgba(0,0,0,.08);
    }

    h3{ margin-top:0; }

    label{
      font-size:12px;
      color:#6b7280;
      display:block;
      margin-bottom:4px;
    }

    input, select, textarea{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #dbeafe;
      background:#f9fbff;
      margin-bottom:10px;
      box-sizing:border-box;
      font-family:inherit;
    }

    input:disabled, select:disabled, textarea:disabled{
      background:#f1f5f9;
      color:#475569;
    }

    button{
      padding:10px 14px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:bold;
      font-family:inherit;
    }

    .primary{ background:var(--brand-orange); color:white; margin-bottom:10px; }
    .danger{ background:#fee2e2; color:#b91c1c; }
    .muted{ color:#6b7280; font-size:12px; margin-top:-6px; margin-bottom:10px; }
    .error{ color:#b91c1c; font-size:12px; margin-top:-6px; margin-bottom:10px; }

    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th, td{ padding:10px; border-bottom:1px solid #e5e7eb; font-size:13px; vertical-align:top; }
    th{ color:#6b7280; text-align:left; }
    .right{ text-align:right; white-space:nowrap; }

    .summary div{ display:flex; justify-content:space-between; margin-bottom:6px; font-size:14px; }
    .total{ font-size:20px; font-weight:bold; }

    /* complementarios alineados a la izquierda */
    .checkboxes{
      border:1px solid #dbeafe;
      background:#f9fbff;
      border-radius:10px;
      padding:12px;
      margin-bottom:10px;
    }
    .checkboxes label{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-start;
      margin-bottom:8px;
      font-size:13px;
      color:#111827;
    }
    .checkboxes input{ margin:0; }
    .checkboxes label:last-child{ margin-bottom:0; }

    .row-inline{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .row-inline input{ margin-bottom:0; flex:1; }
    .row-inline button{ margin-bottom:0; white-space:nowrap; }

    @media(max-width:900px){ .grid{ grid-template-columns:1fr; } }
  </style>
</head>

<body>
<div class="container">

  <div class="header">
    <img src="logo.png" alt="Gauss Control">
    <h1>Cotizador Gauss Control</h1>
  </div>

  <div class="grid">

    <!-- DATOS GENERALES -->
    <div class="card">
      <h3>Datos generales</h3>

      <label>Fecha de Cotizaci√≥n</label>
      <input id="todayDate" disabled>

      <label>V√°lido hasta</label>
      <input id="validUntil" disabled>

      <label>Pa√≠s</label>
      <select id="country">
        <option value="">Seleccionar pa√≠s</option>
        <option value="Per√∫">Per√∫</option>
        <option value="Chile">Chile</option>
        <option value="M√©xico">M√©xico</option>
        <option value="Colombia">Colombia</option>
      </select>

      <label>RUC / RUT</label>
      <input id="taxId" maxlength="11" placeholder="Ej: 20123456789">
      <div id="taxIdError" class="error" style="display:none;"></div>

      <button class="primary" type="button" onclick="lookupTaxId()">Buscar Raz√≥n Social</button>

      <label>Raz√≥n Social</label>
      <input id="businessName" placeholder="(en Per√∫ se completa con el bot√≥n)">

      <label>IGV / IVA</label>
      <input id="tax" disabled>
    </div>

    <!-- DETALLE -->
    <div class="card">
      <h3>DETALLE DE LA COTIZACI√ìN</h3>

      <!-- PRICING SOLO CHILE -->
      <div id="pricingWrap" style="display:none;">
        <label>Pricing</label>
        <select id="pricing">
          <option value="">Seleccionar pricing</option>
          <option value="PAO">PAO</option>
          <option value="CODELCO">CODELCO</option>
          <option value="Otro">Otro</option>
        </select>
      </div>

      <label>Producto / Servicio</label>
      <select id="service">
        <option value="">Seleccionar</option>
        <option>Gauss Alert</option>
        <option>Cognus</option>
        <option>Licencia GA</option>
        <option>Licencia Cognus</option>
        <option>Instalaci√≥n GA</option>
        <option>Instalaci√≥n Cognus</option>
        <option>Implementaci√≥n exitosa</option>
        <option>Gauss Fleet</option>
        <option>Risk 360</option>
      </select>

      <!-- Marca (Gauss Alert) -->
      <div id="brandWrap" style="display:none;">
        <label>Marca</label>
        <select id="brand"></select>
      </div>

      <!-- Complementarios -->
      <div id="addonWrap" style="display:none;">
        <label>¬øContiene dispositivos complementarios?</label>
        <div class="checkboxes" id="addonBox"></div>
        <div class="muted">Puedes marcar m√°s de 1. ‚ÄúNo hay adicional‚Äù no puede combinarse.</div>
      </div>

      <!-- Tipo (Cognus) -->
      <div id="typeWrap" style="display:none;">
        <label>Tipo</label>
        <select id="cognusType">
          <option>Lite</option>
          <option>Pro</option>
          <option>Plus</option>
          <option>Mobile</option>
        </select>
      </div>

      <label>Moneda</label>
      <select id="currency"></select>

      <label>Cantidad</label>
      <input id="qty" type="text" inputmode="numeric" maxlength="4" placeholder="Ej: 40" value="1">

      <label>Precio unitario</label>
      <div class="row-inline">
        <input id="price" type="text" inputmode="decimal" value="0.00" disabled>
        <button class="primary" id="editPriceBtn" type="button">Editar</button>
      </div>

      <button class="primary" type="button" onclick="addItem()">Agregar √≠tem</button>

      <table>
        <thead>
          <tr>
            <th>Detalle</th>
            <th class="right">Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="items"></tbody>
      </table>

      <div class="summary">
        <div><span>Subtotal</span><span id="subtotal">‚Äî</span></div>
        <div><span>IGV / IVA</span><span id="taxValue">‚Äî</span></div>
        <div class="total"><span>Total</span><span id="total">‚Äî</span></div>
      </div>

      <button class="primary" id="pdfBtn" type="button">Convertir en PDF</button>
    </div>

  </div>
</div>

<script>
/* =========================
   Estado / refs
========================= */
const quoteItems = [];
let currencyPrefix = "";

const countrySelect = document.getElementById("country");
const taxInput = document.getElementById("tax");

const taxIdInput = document.getElementById("taxId");
const taxIdError = document.getElementById("taxIdError");
const businessNameInput = document.getElementById("businessName");

const pricingWrap = document.getElementById("pricingWrap");
const pricingSelect = document.getElementById("pricing");

const serviceSelect = document.getElementById("service");

const brandWrap = document.getElementById("brandWrap");
const brandSelect = document.getElementById("brand");

const addonWrap = document.getElementById("addonWrap");
const addonBox = document.getElementById("addonBox");

const typeWrap = document.getElementById("typeWrap");
const cognusType = document.getElementById("cognusType");

const currencySelect = document.getElementById("currency");
const qtyInput = document.getElementById("qty");
const priceInput = document.getElementById("price");
const editPriceBtn = document.getElementById("editPriceBtn");
const pdfBtn = document.getElementById("pdfBtn");

/* =========================
   Config Demo SUNAT
   (Para producci√≥n lo cambiamos a tu Netlify Function)
========================= */
const SUNAT_DEMO_URL = (ruc) => `https://api.apis.net.pe/v2/sunat/ruc/${ruc}?token=demo`;

/* =========================
   Data base
========================= */
const taxByCountry = { "Per√∫":18, "Chile":19, "M√©xico":16, "Colombia":19 };

const currenciesByCountry = {
  "Per√∫":["USD","PEN"],
  "Chile":["UF","CLP","USD"],
  "M√©xico":["USD","MXN"],
  "Colombia":["USD","COP"]
};

const currencyPrefixByCode = {
  "PEN":"S/ ",
  "USD":"USD ",
  "CLP":"CLP ",
  "UF":"UF ",
  "MXN":"MXN ",
  "COP":"COP "
};

const brandsByCountry = {
  "Per√∫":["Queclink"],
  "Chile":["Queclink","Cipia","Mitac"],
  "Colombia":["Queclink","Cipia"],
  "M√©xico":["Queclink","Cipia"]
};

/* =========================
   Reglas de precios
========================= */
const PERU_LICENSE_GA_TIERS = [
  { from: 1,    to: 10,       price: 77 },
  { from: 11,   to: 100,      price: 65 },
  { from: 101,  to: 300,      price: 63 },
  { from: 301,  to: 1000,     price: 59 },
  { from: 1001, to: 3000,     price: 56 },
  { from: 3001, to: Infinity, price: 47 }
];

const PERU_GA_QUECLINK_PRICE_USD = 494;
const PERU_VIBRADOR_PRICE_USD = 220;
const PERU_DASHCAM_PRICE_USD = null; // por ahora sin precio

/* =========================
   Fechas
========================= */
(()=>{
  const now = new Date();
  const fmt = d => d.toLocaleDateString(undefined,{year:"numeric",month:"2-digit",day:"2-digit"});
  document.getElementById("todayDate").value = fmt(now);
  const v = new Date(now); v.setDate(v.getDate()+14);
  document.getElementById("validUntil").value = fmt(v);
})();

/* =========================
   Helpers
========================= */
function showTaxIdError(msg){
  taxIdError.style.display = msg ? "block" : "none";
  taxIdError.textContent = msg || "";
}

function setCurrencyOptions(){
  currencySelect.innerHTML="";
  const opts = currenciesByCountry[countrySelect.value] || ["USD"];
  opts.forEach(c=>{
    const o=document.createElement("option");
    o.value=c; o.textContent=c;
    currencySelect.appendChild(o);
  });
  currencySelect.value = opts[0] || "USD";
  currencyPrefix = currencyPrefixByCode[currencySelect.value] || "";
}

function getSelectedAddons(){
  const cbs = addonBox.querySelectorAll('input[type="checkbox"]');
  return Array.from(cbs).filter(cb => cb.checked).map(cb => cb.value);
}

function renderAddonCheckboxes(options){
  addonBox.innerHTML = "";

  options.forEach(opt=>{
    const row = document.createElement("label");
    row.innerHTML = `<input type="checkbox" value="${opt}"> <span>${opt}</span>`;
    addonBox.appendChild(row);
  });

  addonBox.onchange = (e)=>{
    const target = e.target;
    if(target.tagName !== "INPUT") return;

    const cbs = Array.from(addonBox.querySelectorAll('input[type="checkbox"]'));
    const none = cbs.find(cb => cb.value === "No hay adicional");
    if(!none) return;

    if(target.value === "No hay adicional" && target.checked){
      cbs.forEach(cb => { if(cb !== target) cb.checked = false; });
    } else if(target.value !== "No hay adicional" && target.checked){
      none.checked = false;
    }

    applyAutoPricing();
  };
}

function splitByTiers(qty, tiers){
  let remaining = qty;
  const lines = [];

  for(const t of tiers){
    if(remaining <= 0) break;

    const rangeSize = (t.to === Infinity) ? Infinity : (t.to - t.from + 1);
    const take = Math.min(remaining, rangeSize === Infinity ? remaining : rangeSize);

    if(take > 0){
      lines.push({ from: t.from, to: t.to, qty: take, unitPrice: t.price });
      remaining -= take;
    }
  }
  return lines;
}

function getQtyInt(){
  const raw = (qtyInput.value || "").replace(/\D/g,"").slice(0,4);
  const n = Math.max(1, parseInt(raw || "1", 10));
  return n;
}

/* precio: m√°ximo 2 decimales */
function normalizePriceText(){
  let v = (priceInput.value || "").replace(",", ".").replace(/[^0-9.]/g, "");
  const parts = v.split(".");
  if(parts.length > 2) v = parts[0] + "." + parts.slice(1).join("");
  const [a, b=""] = v.split(".");
  const dec = b.slice(0,2);
  v = dec.length ? `${a || "0"}.${dec}` : (a || "0");
  priceInput.value = v;
}

function getUnitPrice(){
  normalizePriceText();
  const n = Number(priceInput.value || "0");
  return isFinite(n) ? n : 0;
}

/* =========================
   Din√°micos
========================= */
function updateDynamicFields(){
  pricingWrap.style.display = (countrySelect.value === "Chile") ? "block" : "none";
  if(countrySelect.value !== "Chile") pricingSelect.value = "";

  brandWrap.style.display="none";
  addonWrap.style.display="none";
  typeWrap.style.display="none";
  addonBox.innerHTML="";

  if(serviceSelect.value === "Gauss Alert"){
    brandWrap.style.display="block";
    brandSelect.innerHTML="";

    (brandsByCountry[countrySelect.value] || []).forEach(b=>{
      const o=document.createElement("option");
      o.value=b; o.textContent=b;
      brandSelect.appendChild(o);
    });

    updateAddonOptions();
  }

  if(serviceSelect.value === "Cognus"){
    typeWrap.style.display="block";
  }

  applyAutoPricing();
}

function updateAddonOptions(){
  addonWrap.style.display = "none";
  addonBox.innerHTML = "";

  if(serviceSelect.value !== "Gauss Alert") return;

  const brand = brandSelect.value || "";
  if(!brand) return;

  addonWrap.style.display = "block";

  let opts = [];
  if(brand === "Queclink" || brand === "Mitac"){
    opts = ["Vibrador", "No hay adicional"];
  } else if(brand === "Cipia"){
    opts = ["Dashcam", "Vibrador", "No hay adicional"];
  } else {
    opts = ["No hay adicional"];
  }

  renderAddonCheckboxes(opts);
}

/* =========================
   Auto Pricing
========================= */
function applyAutoPricing(){
  // si el usuario est√° editando, no pisar su valor
  if(priceInput.disabled === false) return;

  const country = countrySelect.value;
  const product = serviceSelect.value;
  const brand = brandSelect.value || "";
  const qty = getQtyInt();

  // Chile + PAO + Licencia GA => 1.56 UF (no editable)
  if(country === "Chile" && pricingSelect.value === "PAO" && product === "Licencia GA"){
    currencySelect.value = "UF";
    currencyPrefix = currencyPrefixByCode["UF"];
    priceInput.value = "1.56";
    priceInput.disabled = true;
    editPriceBtn.disabled = true;
    editPriceBtn.textContent = "Editar";
    return;
  }

  // Per√∫: Gauss Alert + Queclink => 494 USD (editable opcional)
  if(country === "Per√∫" && product === "Gauss Alert" && brand === "Queclink"){
    currencySelect.value = "USD";
    currencyPrefix = currencyPrefixByCode["USD"];
    priceInput.value = Number(PERU_GA_QUECLINK_PRICE_USD).toFixed(2);
    priceInput.disabled = true;
    editPriceBtn.disabled = false;
    editPriceBtn.textContent = "Editar";
    return;
  }

  // Per√∫: Licencia GA => por tramos: mostrar PROMEDIO (no editable)
  if(country === "Per√∫" && product === "Licencia GA"){
    currencySelect.value = "USD";
    currencyPrefix = currencyPrefixByCode["USD"];

    const tierLines = splitByTiers(qty, PERU_LICENSE_GA_TIERS);
    const total = tierLines.reduce((s,t)=>s+(t.qty*t.unitPrice),0);
    const avg = total / qty;

    priceInput.value = avg.toFixed(2);
    priceInput.disabled = true;
    editPriceBtn.disabled = true;
    editPriceBtn.textContent = "Editar";
    return;
  }

  currencyPrefix = currencyPrefixByCode[currencySelect.value] || "";
  if(!priceInput.value) priceInput.value = "0.00";
  normalizePriceText();
  editPriceBtn.disabled = false;
  editPriceBtn.textContent = "Editar";
}

/* =========================
   Editar precio
========================= */
editPriceBtn.addEventListener("click", ()=>{
  const country = countrySelect.value;
  const product = serviceSelect.value;

  // si es por tramos, no se edita
  if(country === "Per√∫" && product === "Licencia GA") return;
  if(country === "Chile" && pricingSelect.value === "PAO" && product === "Licencia GA") return;

  const willEnable = priceInput.disabled; // si est√° bloqueado, habilitar
  priceInput.disabled = !willEnable;
  editPriceBtn.textContent = willEnable ? "Bloquear" : "Editar";

  if(willEnable){
    priceInput.focus();
    priceInput.setSelectionRange(priceInput.value.length, priceInput.value.length);
  }else{
    normalizePriceText();
    const n = getUnitPrice();
    priceInput.value = n.toFixed(2);
    render();
  }
});

priceInput.addEventListener("input", ()=>{
  if(priceInput.disabled) return;
  normalizePriceText();
});

priceInput.addEventListener("blur", ()=>{
  if(priceInput.disabled) return;
  const n = getUnitPrice();
  priceInput.value = n.toFixed(2);
  render();
});

/* =========================
   Construcci√≥n de √≠tems con detalle
========================= */
function buildQuoteItem(){
  const country = countrySelect.value;
  const product = serviceSelect.value;
  const pricing = pricingSelect.value || "";
  const brand = brandSelect.value || "";
  const addons = getSelectedAddons();
  const qty = getQtyInt();

  const currency = currencySelect.value || "USD";
  const prefix = currencyPrefixByCode[currency] || "";

  let header = product || "(sin producto)";
  if(country === "Chile" && pricing) header = `[${pricing}] ${header}`;
  if(product === "Gauss Alert" && brand) header += ` - ${brand}`;

  const lines = [];

  // Per√∫ - Licencia GA: tramos con detalle
  if(country === "Per√∫" && product === "Licencia GA"){
    const tierLines = splitByTiers(qty, PERU_LICENSE_GA_TIERS);

    tierLines.forEach(tl=>{
      const total = tl.qty * tl.unitPrice;
      const rangeLabel = (tl.to === Infinity) ? `${tl.from}+` : `${tl.from}‚Äì${tl.to}`;
      lines.push({
        desc: `‚Ä¢ Tramo ${rangeLabel}: ${tl.qty} x ${tl.unitPrice.toFixed(2)} = ${prefix}${total.toFixed(2)}`,
        total
      });
    });

    const itemTotal = lines.reduce((s,l)=>s+l.total,0);
    return { header: `${header} (por tramos)`, prefix, total: itemTotal, lines };
  }

  // Caso general: usa el precio unitario actual (auto o editado)
  const unit = getUnitPrice();
  const baseTotal = qty * unit;
  lines.push({
    desc: `‚Ä¢ Base: ${qty} x ${unit.toFixed(2)} = ${prefix}${baseTotal.toFixed(2)}`,
    total: baseTotal
  });

  // Complementos (1 por unidad)
  if(product === "Gauss Alert" && addons.length){
    addons.forEach(a=>{
      if(a === "No hay adicional") return;

      if(country === "Per√∫" && a === "Vibrador"){
        const total = qty * PERU_VIBRADOR_PRICE_USD;
        lines.push({
          desc: `‚Ä¢ Complemento Vibrador: ${qty} x ${PERU_VIBRADOR_PRICE_USD.toFixed(2)} = ${prefix}${total.toFixed(2)}`,
          total
        });
      } else if(country === "Per√∫" && a === "Dashcam"){
        if(PERU_DASHCAM_PRICE_USD == null){
          lines.push({ desc: `‚Ä¢ Complemento Dashcam: (sin precio configurado)`, total: 0 });
        } else {
          const total = qty * PERU_DASHCAM_PRICE_USD;
          lines.push({
            desc: `‚Ä¢ Complemento Dashcam: ${qty} x ${PERU_DASHCAM_PRICE_USD.toFixed(2)} = ${prefix}${total.toFixed(2)}`,
            total
          });
        }
      } else {
        lines.push({ desc: `‚Ä¢ Complemento ${a}: (sin precio configurado)`, total: 0 });
      }
    });
  }

  const itemTotal = lines.reduce((s,l)=>s+l.total,0);
  return { header: addons.length ? `${header} (${addons.join(", ")})` : header, prefix, total: itemTotal, lines };
}

/* =========================
   Add / Render
========================= */
function addItem(){
  if(!serviceSelect.value){
    alert("Selecciona un Producto / Servicio.");
    return;
  }

  qtyInput.value = String(getQtyInt());
  applyAutoPricing();

  const item = buildQuoteItem();
  quoteItems.push(item);
  render();
}

function fmtMoney(prefix, n){
  return `${prefix}${Number(n||0).toFixed(2)}`;
}

function render(){
  const tbody = document.getElementById("items");
  tbody.innerHTML = "";

  let subtotal = 0;

  quoteItems.forEach((it, idx)=>{
    subtotal += it.total;

    tbody.innerHTML += `
      <tr>
        <td><b>${it.header}</b></td>
        <td class="right"><b>${fmtMoney(it.prefix, it.total)}</b></td>
        <td class="right"><button class="danger" type="button" onclick="removeItem(${idx})">X</button></td>
      </tr>
    `;

    it.lines.forEach(line=>{
      tbody.innerHTML += `
        <tr>
          <td style="padding-left:22px; color:#374151;">${line.desc}</td>
          <td class="right">${fmtMoney(it.prefix, line.total)}</td>
          <td></td>
        </tr>
      `;
    });
  });

  const taxPct = (Number(taxInput.value) || 0) / 100;
  const taxVal = subtotal * taxPct;

  const displayPrefix = currencyPrefixByCode[currencySelect.value] || "";
  document.getElementById("subtotal").innerText = fmtMoney(displayPrefix, subtotal);
  document.getElementById("taxValue").innerText = fmtMoney(displayPrefix, taxVal);
  document.getElementById("total").innerText = fmtMoney(displayPrefix, subtotal + taxVal);
}

function removeItem(i){
  quoteItems.splice(i,1);
  render();
}

/* =========================
   Buscar Raz√≥n Social (Per√∫) - DEMO FUNCIONAL
========================= */
async function lookupTaxId(){
  showTaxIdError("");

  if(countrySelect.value !== "Per√∫"){
    showTaxIdError("La b√∫squeda autom√°tica solo est√° configurada para Per√∫.");
    return;
  }

  const ruc = (taxIdInput.value || "").trim();
  if(!/^\d{11}$/.test(ruc)){
    showTaxIdError("El RUC debe tener 11 d√≠gitos num√©ricos.");
    return;
  }

  businessNameInput.value = "Buscando...";

  try{
    const res = await fetch(SUNAT_DEMO_URL(ruc));
    if(!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();

    const rs = data.razonSocial || data.nombre || "";
    businessNameInput.value = rs || "";
    if(!rs){
      showTaxIdError("No se encontr√≥ raz√≥n social para ese RUC.");
    }
  }catch(e){
    businessNameInput.value = "";
    showTaxIdError("No se pudo consultar la raz√≥n social (demo).");
  }
}

/* =========================
   Events
========================= */
countrySelect.addEventListener("change", ()=>{
  showTaxIdError("");
  businessNameInput.value = "";

  taxInput.value = taxByCountry[countrySelect.value] || "";
  pricingWrap.style.display = countrySelect.value === "Chile" ? "block" : "none";
  if(countrySelect.value !== "Chile") pricingSelect.value = "";

  setCurrencyOptions();

  // volver a modo precio bloqueado al cambiar pa√≠s
  priceInput.disabled = true;
  editPriceBtn.textContent = "Editar";
  editPriceBtn.disabled = false;

  updateDynamicFields();
  render();
});

currencySelect.addEventListener("change", ()=>{
  currencyPrefix = currencyPrefixByCode[currencySelect.value] || "";
  applyAutoPricing();
  render();
});

serviceSelect.addEventListener("change", ()=>{
  // al cambiar producto, volver a precio bloqueado para que aplique auto pricing
  priceInput.disabled = true;
  editPriceBtn.textContent = "Editar";
  editPriceBtn.disabled = false;

  updateDynamicFields();
  render();
});

pricingSelect.addEventListener("change", ()=>{
  priceInput.disabled = true;
  editPriceBtn.textContent = "Editar";
  editPriceBtn.disabled = false;
  applyAutoPricing();
  render();
});

brandSelect.addEventListener("change", ()=>{
  priceInput.disabled = true;
  editPriceBtn.textContent = "Editar";
  editPriceBtn.disabled = false;
  updateAddonOptions();
  applyAutoPricing();
  render();
});

// Cantidad: solo enteros, max 4 d√≠gitos (sin bloquear escritura)
qtyInput.addEventListener("input", ()=>{
  qtyInput.value = (qtyInput.value || "").replace(/\D/g,"").slice(0,4);
});

qtyInput.addEventListener("blur", ()=>{
  qtyInput.value = String(getQtyInt());
  applyAutoPricing();
  render();
});

pdfBtn.addEventListener("click", ()=>{
  alert("Pr√≥ximamente: Convertir a PDF üôÇ");
});

/* =========================
   Init
========================= */
(()=>{
  taxInput.value = "";
  setCurrencyOptions();
  priceInput.value = "0.00";
  priceInput.disabled = true;
  editPriceBtn.textContent = "Editar";
  editPriceBtn.disabled = false;
  updateDynamicFields();
  render();
})();
</script>
</body>
</html>
